## ì›¹ ìŠ¤ì½”í”„ì˜ íŠ¹ì§•

- ì›¹ í™˜ê²½ì—ì„œë§Œ ë™ì‘
- ìŠ¤í”„ë§ì´ í•´ë‹¹ ìŠ¤ì½”í”„ì˜ ì¢…ë£Œì‹œì ê¹Œì§€ ê´€ë¦¬
- ì¢…ë£Œ ë©”ì†Œë“œ í˜¸ì¶œ

## ì›¹ ìŠ¤ì½”í”„ ì¢…ë¥˜

- **request**: HTTP ìš”ì²­ í•˜ë‚˜ê°€ ë“¤ì–´ì˜¤ê³  ë‚˜ê°ˆ ë–„ ê¹Œì§€ ìœ ì§€ë˜ëŠ” ìŠ¤ì½”í”„, ê°ê°ì˜ HTTP ìš”ì²­ë§ˆë‹¤ ë³„ë„ì˜ ë¹ˆ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ê³ , ê´€ë¦¬ëœë‹¤.
- **session**: HTTP Sessionê³¼ ë™ì¼í•œ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§€ëŠ” ìŠ¤ì½”í”„
- **application**: ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸(ServletContext)ì™€ ë™ì¼í•œ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§€ëŠ” ìŠ¤ì½”í”„
- **websocket**: ì›¹ ì†Œì¼“ê³¼ ë™ì¼í•œ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§€ëŠ” ìŠ¤ì½”í”„

## request ìŠ¤ì½”í”„ ì˜ˆì œ ë§Œë“¤ê¸°

### ì›¹ í™˜ê²½ ì¶”ê°€

**build.gradleì— ì¶”ê°€**

```java
//web ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
implementation 'org.springframework.boot:spring-boot-starter-web'
```

> **ì°¸ê³ **: `spring-boot-starter-web` ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ ì‹œ ë‚´ì¥ í†°ìº£ ì„œë²„ë¥¼ í™œìš©í•˜ì—¬ ì›¹ì„œë²„ì™€ ìŠ¤í”„ë§ì„ í•¨ê»˜ ì‹¤í–‰
> 

> **ì°¸ê³ **: ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ì›¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ìœ¼ë©´ `AnnotationConfigApplicationContext`ì„ ê¸°ë°˜ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ë™í•œë‹¤.
ì›¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì¶”ê°€ë  ê²½ìš° `AnnotationConfigServletWebServerApplicationContext`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ë™í•œë‹¤.
> 

### request ìŠ¤ì½”í”„ ì˜ˆì œ ê°œë°œ

ë™ì‹œì— ì—¬ëŸ¬ HTTP ìš”ì²­ì´ ì˜¤ë©´ ì •í™•íˆ ì–´ë–¤ ìš”ì²­ì´ ë‚¨ê¸´ ë¡œê·¸ì¸ì§€ êµ¬ë¶„í•˜ê¸° ì–´ë µë‹¤.

ì´ ê²½ìš° request ìŠ¤ì½”í”„ë¥¼ í™œìš©í•˜ì—¬ ì¶”ê°€ ê¸°ëŠ¥ì„ ê°œë°œí•´ë³´ì.

> **ì°¸ê³ **: Springì—ì„œëŠ” ì´ë¯¸ `Filter`ë‚˜ `Interceptor`ë¥¼ ì œê³µí•˜ì—¬ ìœ„ì™€ ê°™ì€ ë¹„ìŠ·í•œ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤. ê·¸ëŸ¬ë‚˜ ì‹¤ìŠµì„ ìœ„í•´ request ìŠ¤ì½”í”„ ì˜ˆì œë¡œ ê°œë°œí•´ë³¸ë‹¤.
> 
- ê¸°ëŒ€í•˜ëŠ” ê³µí†µ í¬ë©§: [UUID][requestURL]{message}
- UUIDë¥¼ ì‚¬ìš©í•˜ì—¬ HTTP ìš”ì²­ì„ êµ¬ë¶„

**MyLogger**

```java
@Component
@Scope(value = "request")
public class MyLogger {

    private String uuid;
    private String requestURL;

    public void setRequestURL(String requestURL) {
        this.requestURL = requestURL;
    }

    public void log(String message) {
        System.out.println("[" + uuid + "]" + "[" + requestURL + "]" + message);
    }

    @PostConstruct
    public void init() {
        uuid = UUID.randomUUID().toString(); // ê²¹ì¹˜ì§€ ì•ŠëŠ” uuid ìƒì„±
        System.out.println("[" + uuid + "] request scope bean create: " + this);
    }

    @PreDestroy
    public void destroy() {
        System.out.println("[" + uuid + "] request scope bean close: " + this);
    }
}
```

- `@PostConstruct` ì´ˆê¸°í™” ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ UUIDë¥¼ ìƒì„±í•˜ì—¬ ì €ì¥í•œë‹¤.
- `@PreDestroy`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹ˆì´ ì†Œë©¸ë˜ëŠ” ì‹œì ì— ì¢…ë£Œ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸´ë‹¤.

**LogDemoController**

```java
@RestController
@RequiredArgsConstructor
public class LogDemoController {

    private final LogDemoService logDemoService;

    @GetMapping("log-demo")
    public String logDemo(HttpServletRequest request) {
        String requestURL = request.getRequestURI();

        MyLogger myLogger = myLoggerProvider.getObject();
        myLogger.setRequestURL(requestURL);
        myLogger.log("controller test");

        logDemoService.log("testId");
        return "OK";
    }
}
```

**LogDemoService**

```java
@Service
@RequiredArgsConstructor
public class LogDemoService {

    private final MyLoggerProxy myLoggerProxy;

    public void log(String id) {
        MyLogger myLogger = myLoggerProvider.getObject();
        myLogger.log("service id = " + id);
    }
}
```

- request scopeë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  íŒŒë¼ë¯¸í„°ë¡œ ëª¨ë“  ì •ë³´ë¥¼ ì„œë¹„ìŠ¤ ê³„ì¸µì— ë„˜ê¸´ë‹¤ë©´, íŒŒë¼ë¯¸í„°ê°€ ë§ì•„ì ¸ ì§€ì ¸ë¶„ í•˜ë‹¤ëŠ” ë‹¨ì ì´ ìƒê¸´ë‹¤.
- ë˜í•œ requestURL ê°™ì€ ì›¹ê³¼ ê´€ë ¨ëœ ì •ë³´ê°€ ê´€ë ¨ ì—†ëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µê¹Œì§€ ë„˜ì–´ê°€ê²Œ ëœë‹¤. SRPë¥¼ ìœ„ë°˜í•œë‹¤!
- request scopeì˜ MyLogger ë•ë¶„ì— íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸°ì§€ ì•Šê³ , MyLoggerì˜ ë©¤ë²„ë³€ìˆ˜ì— ì €ì¥í•˜ì—¬ ì½”ë“œì™€ ê³„ì¸µì„ ê¹”ë”í•˜ê²Œ ìœ ì§€í•  ìˆ˜ ìˆë‹¤.

### ê¸°ëŒ€í•˜ëŠ” ì¶œë ¥

```java
[e8ab1f58-c1a0-4fe8-8681-4d1f139cc498] request scope bean create: hello.core.common.MyLogger@15398e4e
[e8ab1f58-c1a0-4fe8-8681-4d1f139cc498][/log-demo]controller test
[e8ab1f58-c1a0-4fe8-8681-4d1f139cc498][/log-demo]service id = testId
[e8ab1f58-c1a0-4fe8-8681-4d1f139cc498] request scope bean close: hello.core.common.MyLogger@15398e4e
```

### ì‹¤ì œëŠ” ê¸°ëŒ€ì™€ ë‹¤ë¥´ê²Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì‹¤í–‰ì‹œì ì— ì˜¤ë¥˜ ë°œìƒ

```java
Error creating bean with name 'myLogger': Scope 'request' is not active for the
current thread; consider defining a scoped proxy for this bean if you intend to
refer to it from a singleton;
```

- ì‹±ê¸€í†¤ ë¹ˆì€ ì‹¤í–‰ ì‹œì ì— ìƒì„±í•˜ì—¬ ì£¼ì…ì´ ê°€ëŠ¥í•˜ì§€ë§Œ, request ìŠ¤ì½”í”„ ë¹ˆì€ ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠëŠ”ë‹¤.
- ì´ ë¹ˆì€ ì‹¤ì œ ê³ ê°ì˜ ìš”ì²­ì´ ì™€ì•¼ ìƒì„± ê°€ëŠ¥í•˜ë‹¤.

## ìŠ¤ì½”í”„ì™€ Provider

- ì•ì„œ í¬ìŠ¤íŒ…í•œ Providerë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ê²° ê°€ëŠ¥í•˜ë‹¤.

```java
@RestController
@RequiredArgsConstructor
public class LogDemoController {

    private final LogDemoService logDemoService;
    private final ObjectProvider<MyLogger> myLoggerProvider;

    @GetMapping("log-demo")
    public String logDemo(HttpServletRequest request) {
        String requestURL = request.getRequestURI();

        MyLogger myLogger = myLoggerProvider.getObject();
        myLogger.setRequestURL(requestURL);
        myLogger.log("controller test");

        logDemoService.log("testId");
        return "OK";
    }
}
```

```java
@Service
@RequiredArgsConstructor
public class LogDemoService {

    private final ObjectProvider<MyLogger> myLoggerProvider;

    public void log(String id) {
        MyLogger myLogger = myLoggerProvider.getObject();
        myLogger.log("service id = " + id);
    }
}
```

- `ObjectProvider` ì‚¬ìš©ìœ¼ë¡œ `getObject()`ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ê¹Œì§€ request scope ë¹ˆì˜ ìƒì„±ì„ ì§€ì—° ê°€ëŠ¥
- `ObjectProvider.getObject()`ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ì— HTTP ìš”ì²­ì´ ì§„í–‰ ì¤‘ì´ë¯€ë¡œ request scope ë¹ˆì˜ ìƒì„±ì´ ì •ìƒ ì²˜ë¦¬
- `LogDemoController`, `LogDemoService`ì—ì„œ ê°ê° ë”°ë¡œ í˜¸ì¶œí•˜ì—¬ë„ ê°™ì€ HTTP ìš”ì²­ì´ë©´ ê°™ì€ ìŠ¤í”„ë§ ë¹ˆì´ ë°˜í™˜

## ìŠ¤ì½”í”„ì™€ í”„ë¡ì‹œ

```java
@Component
@Scope(value = "request", proxyMode = ScopedProxyMode.TARGET_CLASS)
public class MyLoggerProxy {
	// ...
}
```

- `TARGET_CLASS`: ì ìš© ëŒ€ìƒì´ í´ë˜ìŠ¤
- `INTERFACES`: ì ìš© ëŒ€ìƒì´ ì¸í„°í˜ì´ìŠ¤
- MyLoggerì˜ ê°€ì§œ í”„ë¡ì‹œ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ ë‘ê³ , HTTP requestì™€ ìƒê´€ì—†ì´ ê°€ì§œ í”„ë¡ì‹œ í´ë˜ìŠ¤ë¥¼ ë‹¤ë¥¸ ë¹ˆì— ë¯¸ë¦¬ ì£¼ì…í•´ ë‘”ë‹¤.

```java
@RestController
@RequiredArgsConstructor
public class LogDemoController {

    private final LogDemoService logDemoService;
    private final MyLoggerProxy myLoggerProxy;

    @GetMapping("log-demo-proxy")
    public String logDemoProxy(HttpServletRequest request) {
        String requestURL = request.getRequestURI();

        System.out.println("myLoggerProxy = " + myLoggerProxy.getClass());
        myLoggerProxy.setRequestURL(requestURL);
        myLoggerProxy.log("testId");

        logDemoService.logProxy("testId");
        return "OK";
    }
}
```

```java
@Service
@RequiredArgsConstructor
public class LogDemoService {

    private final MyLoggerProxy myLoggerProxy;

    public void logProxy(String id) {
        myLoggerProxy.log("service id = " + id);
    }
}
```

### ì›¹ ìŠ¤ì½”í”„ì™€ í”„ë¡ì‹œ ë™ì‘ ì›ë¦¬

ì£¼ì…ëœ MyLoggerProxyë¥¼ í™•ì¸í•´ë³´ì

```java
myLoggerProxy = class hello.core.common.MyLoggerProxy$$EnhancerBySpringCGLIB$$268cea5a
```

**CGLIBë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë‚´ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì€ ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ ì£¼ì…í•œë‹¤.**

- ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” CGLIBë¼ëŠ” ë°”ì´íŠ¸ì½”ë“œë¥¼ ì¡°ì‘í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬, MyLoggerProxyë¥¼ ìƒì†ë°›ì€ ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
- ê·¸ë¦¬ê³  ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— "myLoggerProxy"ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì§„ì§œ ëŒ€ì‹  ì´ ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ë¥¼ ë“±ë¡í•œë‹¤.

**ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ëŠ” ìš”ì²­ì´ ì˜¤ë©´ ê·¸ë•Œ ë‚´ë¶€ì—ì„œ ì§„ì§œ ë¹ˆì„ ìš”ì²­í•˜ëŠ” ìœ„ì„ ë¡œì§ì´ ë“¤ì–´ìˆë‹¤.**

- ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ëŠ” ë‚´ë¶€ì— ì§„ì§œ myLoggerë¥¼ ì°¾ëŠ” ë°©ë²•ì„ ì•Œê³  ìˆë‹¤.
- í´ë¼ì´ì–¸íŠ¸ê°€ `myLogger.logic()`ì„ í˜¸ì¶œí•˜ë©´ ì‚¬ì‹¤ì€ ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ì˜ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œ ê²ƒì´ë‹¤.
- ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ëŠ” ì›ë³¸ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì•„ì„œ ë§Œë“¤ì–´ì¡Œê¸° ë•Œë¬¸ì— ì´ ê°ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸
ì…ì¥ì—ì„œëŠ” ì‚¬ì‹¤ ì›ë³¸ì¸ì§€ ì•„ë‹Œì§€ë„ ëª¨ë¥´ê²Œ, ë™ì¼í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. (ë‹¤í˜•ì„±)

**ë™ì‘ ì •ë¦¬**

- CGLIBë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í†µí•´ ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ë¥¼ ë§Œë“¤ì–´ ì£¼ì…
- ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ëŠ” ì‹¤ì œ ìš”ì²­ì´ ì˜¤ë©´ ê·¸ë•Œ ë‚´ë¶€ì—ì„œ ì‹¤ì œ ë¹ˆì„ ìš”ì²­í•˜ëŠ” ìœ„ì„ ë¡œì§ì´ ì¡´ì¬
- ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ëŠ” scoptì™€ëŠ” ê´€ê³„ ì—†ë‹¤. ë‚´ë¶€ì— ë‹¨ìˆœí•œ ìœ„ì„ ë¡œì§ë§Œ ì¡´ì¬í•˜ë©°, ì‹±ê¸€í†¤ ì²˜ëŸ¼ ë™ì‘í•œë‹¤.

### ì£¼ì˜ì 

- ì‹±ê¸€í†¤ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒ ê°™ì§€ë§Œ ë‹¤ë¥´ê²Œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— ì‚¬ìš©ì— ì£¼ì˜í•˜ì—¬ì•¼ í•œë‹¤!
- ì´ëŸ° íŠ¹ë³„í•œ scopeëŠ” ê¼­ í•„ìš”í•œ ê³³ì—ë§Œ ìµœì†Œí™”í•˜ì—¬ ì‚¬ìš©í•˜ì, ë¬´ë¶„ë³„í•˜ê²Œ ì‚¬ìš©í•  ê²½ìš° ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì–´ë ¤ì›Œì§„ë‹¤.

# ğŸ“„ Reference

- [[ì¸í”„ëŸ°] ìŠ¤í”„ë§ í•µì‹¬ ì›ë¦¬ - ê¸°ë³¸í¸ (ê¹€ì˜í•œ)](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-%ED%95%B5%EC%8B%AC-%EC%9B%90%EB%A6%AC-%EA%B8%B0%EB%B3%B8%ED%8E%B8/dashboard)